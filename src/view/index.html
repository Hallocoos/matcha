<html lang="en">

<head>
  <meta charset="UTF-8">
</head>

<body>
  <p data-bind="if: token(), style: {padding: 14}">
    <span data-bind="click: selectView.bind($data, 'match'), style: {padding: 14}">Match</span>
    <span data-bind="click: selectView.bind($data, 'chat'), style: {padding: 14}">Chat</span>
    <span data-bind="click: selectView.bind($data, 'profile'), style: {padding: 14}">Profile</span>
    <span data-bind="click: selectView.bind($data, 'settings'), style: {padding: 14}">Settings</span>
    <span data-bind="click: selectView.bind($data, 'notifications'), style: {padding: 14}">Notifications</span>
    <span data-bind="click: logOut, style: {padding: 14}">Log Out</span>
    <hr>
  </p>

  <div data-bind="if: selectedView() == 'login'">
    <h3>Enter credentials to log in</h3>
    <table>
      <tr>
        <td>Username:</td>
        <td>Password:</td>
      </tr>
      <tr>
        <td>
          <input data-bind="value: username">
        </td>
        <td>
          <input data-bind="value: password">
        </td>
        <td>
          <button data-bind="click: submitCreds">Log In</button>
        </td>
      </tr>
      <tr>
        <td></td>
        <td>
          <h6>Oops. I need to <a href="" data-bind="click: selectView.bind($data, 'resetrequest')">reset my
              password</a>.</h6>
        </td>
      </tr>
    </table>
    <h3>New user? Click here to <a href="" data-bind="click: selectView.bind($data, 'register')">register</a>.</h3>
  </div>

  <div data-bind="if: selectedView() == 'match'">
    <h1>This will be match view.</h1>
  </div>

  <div data-bind="if: selectedView() == 'chat'">
    <h1>This will be chat view.</h1>
  </div>

  <div data-bind="if: selectedView() == 'profile'">
    <!-- 
      wip   images can display, implement set as profile pic
      username no edit
      firstname
      lastname
      age
      gender
      biography
      interest
      tags
      famerating not editable
      gps implement editing
    -->
    <div data-bind="foreach: {data: ownImageSources, as: 'imageSource'}">
      <img width="15%" height="auto" data-bind="attr: {src: imageSource}">
    </div>
    <br>

    <div>
      <b>Username</b> <!-- no edit -->
      <div data-bind="text: loggedInUser.username"></div>
      <br>

      <b>firstname</b>
      <!-- ko if: settingEditing() != 'firstname'-->
      <button data-bind="click: selectSettingEditing.bind($data, 'firstname')">Edit</button>
      <div data-bind="text: loggedInUser.firstname"></div>
      <!-- /ko -->
      <!-- ko if: settingEditing() == 'firstname'-->
      <button data-bind="click: saveChangesToLoggedInUser">Save</button>
      <div>
        <input data-bind="value: settingEditingWorkspace">
      </div>
      <!-- /ko -->
      <br>

      <b>lastname</b>
      <!-- ko if: settingEditing() != 'lastname'-->
      <button data-bind="click: selectSettingEditing.bind($data, 'lastname')">Edit</button>
      <div data-bind="text: loggedInUser.lastname"></div>
      <!-- /ko -->
      <!-- ko if: settingEditing() == 'lastname'-->
      <button data-bind="click: saveChangesToLoggedInUser">Save</button>
      <div>
        <input data-bind="value: settingEditingWorkspace">
      </div>
      <!-- /ko -->
      <br>

      <b>age</b>
      <!-- ko if: settingEditing() != 'age'-->
      <button data-bind="click: selectSettingEditing.bind($data, 'age')">Edit</button>
      <div data-bind="text: loggedInUser.age"></div>
      <!-- /ko -->
      <!-- ko if: settingEditing() == 'age'-->
      <button data-bind="click: saveChangesToLoggedInUser">Save</button>
      <div>
        <input data-bind="value: settingEditingWorkspace">
      </div>
      <!-- /ko -->
      <br>

      <b>gender</b>
      <!-- ko if: settingEditing() != 'gender'-->
      <button data-bind="click: selectSettingEditing.bind($data, 'gender')">Edit</button>
      <div data-bind="text: loggedInUser.gender"></div>
      <!-- /ko -->
      <!-- ko if: settingEditing() == 'gender'-->
      <button data-bind="click: saveChangesToLoggedInUser">Save</button>
      <div>
        <input data-bind="value: settingEditingWorkspace" list="genderList">
        <datalist id="genderList">
          <option value="other">
          <option value="female">
          <option value="male">
        </datalist>
      </div>
      <!-- /ko -->
      <br>

      <b>biography</b>
      <!-- ko if: settingEditing() != 'biography'-->
      <button data-bind="click: selectSettingEditing.bind($data, 'biography')">Edit</button>
      <div data-bind="text: loggedInUser.biography() ? loggedInUser.biography : 'Not yet completed.'"></div>
      <!-- /ko -->
      <!-- ko if: settingEditing() == 'biography'-->
      <button data-bind="click: saveChangesToLoggedInUser">Save</button>
      <div>
        <input data-bind="value: settingEditingWorkspace">
      </div>
      <!-- /ko -->
      <br>

      <b>interest</b>
      <!-- ko if: settingEditing() != 'interest'-->
      <button data-bind="click: selectSettingEditing.bind($data, 'interest')">Edit</button>
      <div data-bind="text: loggedInUser.interest"></div>
      <!-- /ko -->
      <!-- ko if: settingEditing() == 'interest'-->
      <button data-bind="click: saveChangesToLoggedInUser">Save</button>
      <div>
        <input data-bind="value: settingEditingWorkspace" list="genderList">
        <datalist id="genderList">
          <option value="other">
          <option value="female">
          <option value="male">
        </datalist>
      </div>
      <!-- /ko -->
      <br>

      <b>tags</b>
      <!-- ko if: settingEditing() != 'tags'-->
      <button data-bind="click: selectSettingEditing.bind($data, 'tags')">Edit</button>
      <div data-bind="text: loggedInUser.tags"></div>
      <!-- /ko -->
      <!-- ko if: settingEditing() == 'tags'-->
      <button data-bind="click: saveChangesToLoggedInUser">Save</button>
      <div>
        <input data-bind="value: settingEditingWorkspace">
      </div>
      <!-- /ko -->
      <br>

      <b>fame not editable</b> <!-- no edit -->
      <div
        data-bind="text: loggedInUser.fame() ? loggedInUser.fame : 'No fame rating yet. Interact with other users to increase.'">
      </div>
      <br>

      <!-- ko if: loggedInUser.locationTracking -->
      <b>gps implement editing</b>
      <!-- ko if: settingEditing() != 'gps'-->
      <button data-bind="click: selectSettingEditing.bind($data, 'gps')">Edit</button>
      <table>
        <tr>
          <td>
            <div data-bind="text: 'Latitude:'"></div>
          </td>
          <td>
            <div data-bind="text: loggedInUser.latitude"></div>
          </td>
        </tr>
        <tr>
          <td>
            <div data-bind="text: 'Longitude:'"></div>
          </td>
          <td>
            <div data-bind="text: loggedInUser.longitude"></div>
          </td>
        </tr>
      </table>
      <!-- /ko -->
      <!-- ko if: settingEditing() == 'gps'-->
      <button data-bind="click: saveChangesToLoggedInUser">Save</button>
      <div>
        <input data-bind="value: settingEditingWorkspace">
      </div>
      <!-- /ko -->
      <br>
      <!-- /ko -->

    </div>

  </div>

  <div data-bind="if: selectedView() == 'settings'">
    <!-- username -->
    <!-- password -->
    <!-- email -->
    <!-- dis/enable gps-->
    <h3>Pick a setting to change.</h3>




    <b>Username</b>
    <!-- ko if: settingEditing() != 'username'-->
    <button data-bind="click: selectSettingEditing.bind($data, 'username')">Edit</button>
    <div data-bind="text: loggedInUser.username"></div>
    <!-- /ko -->
    <!-- ko if: settingEditing() == 'username'-->
    <button data-bind="click: saveChangesToLoggedInUser">Save</button>
    <div>
      <input data-bind="value: settingEditingWorkspace">
    </div>
    <!-- /ko -->
    <br>

    <b>Password</b>
    <!-- ko if: settingEditing() != 'password' -->
    <button data-bind="click: selectSettingEditing.bind($data, 'password')">Edit</button>
    <!-- /ko -->
    <!-- ko if: settingEditing() == 'password' -->
    <button data-bind="click: saveChangesToLoggedInUser">Save</button>
    <div>
      <input data-bind="value: settingEditingWorkspace">
    </div>
    <!-- /ko -->
    <br>

    <b>Email</b>
    <!-- ko if: settingEditing() != 'email' -->
    <button data-bind="click: selectSettingEditing.bind($data, 'email')">Edit</button>
    <div data-bind="text: loggedInUser.email"></div>
    <!-- /ko -->
    <!-- ko if: settingEditing() == 'email' -->
    <button data-bind="click: saveChangesToLoggedInUser">Save</button>
    <div>
      <input data-bind="value: settingEditingWorkspace">
    </div>
    <!-- /ko -->
    <br>

    <b>Location Tracking</b>
    <button data-bind="click: selectSettingEditing.bind($data, 'locationTracking')">Toggle</button>
    <div data-bind="text: loggedInUser.locationTracking() == 1 ? 'Enabled' : 'Disabled'"></div>
    <br>

  </div>

  <div data-bind="if: selectedView() == 'notifications'">
    <h1>This will be notifications view.</h1>
    <!-- <h6>test</h6> -->
  </div>

  <div data-bind="if: selectedView() == 'reset'">
    <h3>Please enter your new password:</h3>
    <input data-bind="value: password">
    <button data-bind="click: sendNewPassword">Reset Password</button>
    <div><button data-bind="click: logOut">Return to Log In</button></div>
  </div>

  <div data-bind="if: selectedView() == 'resetrequest'">
    <h3>Please provide your email address:</h3>
    <input data-bind="value: email">
    <button data-bind="click: sendResetPasswordRequest">Send Request</button>
    <div><button data-bind="click: logOut">Return to Log In</button></div>
  </div>

  <div data-bind="if: selectedView() == 'register'">
    <h3>Please provide the following information to register:</h3>
    <div>Username:</div>
    <input data-bind="value: newRegistration.username">
    <div>Firstname:</div>
    <input data-bind="value: newRegistration.firstname">
    <div>Lastname:</div>
    <input data-bind="value: newRegistration.lastname">
    <div>Age:</div>
    <input data-bind="value: newRegistration.age">
    <div>Gender:</div>
    <input data-bind="value: newRegistration.gender" list="genderList">
    <datalist id="genderList">
      <option value="other">
      <option value="female">
      <option value="male">
    </datalist>
    <div>Email:</div>
    <input data-bind="value: newRegistration.email">
    <div>Password:</div>
    <input data-bind="value: newRegistration.password">
    <button data-bind="click: sendNewRegistrationToDb">Register</button>
    <p> </p>
    <div>
      <button data-bind="click: logOut">Return to Log In</button>
    </div>
  </div>

  <div id="errordiv"></div>

</body>

<script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js'></script>
<script type='text/javascript' src='knockout.mapping.js'></script>
<script>

  async function putUserInViewModel() {
    var body = JSON.stringify({
      username: viewModel.username(),
    })
    await fetch("http://localhost:3000/profile", {
      method: "POST",
      body: body,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + viewModel.token(),
      },
    }).then(response =>
      response.json()
    ).then(data => {
      console.log(data)
      if (data.user && data.images) {
        viewModel.loggedInUser = ko.mapping.fromJS(data.user)
        viewModel.ownImageSources([])
        data.images.forEach(image => {
          viewModel.ownImageSources().push("data:image/png;base64, " + image.image)
        });
      } else {
        if (!alert('Unable to complete login. Please try again.')) { window.location.replace("http://localhost:3000/matcha") }
      }
    }).catch(er => {
      document.getElementById("errordiv").innerHTML = "Error setting logged in user data. Reason: " + er.message + "."
    })
    // console.log(ko.toJS(viewModel.loggedInUser))
    // console.log(viewModel.ownImageSources())
  }

  function resetSettingEditing() {
    // console.log("reset setting editing called")
    viewModel.settingEditing('')
    viewModel.settingEditingWorkspace('')
  }

  var viewModel = {
    email: ko.observable(''),
    loggedInUser: null,
    newRegistration: {
      age: ko.observable(''),
      email: ko.observable(''),
      firstname: ko.observable(''),
      gender: ko.observable(''),
      lastname: ko.observable(''),
      password: ko.observable(''),
      username: ko.observable(''),
    },
    ownImageSources: ko.observable([]),
    password: ko.observable(''),
    reset: ko.observable(),
    selectedView: ko.observable(''),
    settingEditing: ko.observable(''),
    settingEditingWorkspace: ko.observable(''),
    token: ko.observable(),
    username: ko.observable(''),

    logOut() {
      window.location.replace("http://localhost:3000/matcha")
    },

    async selectSettingEditing(setting, data) {
      viewModel.settingEditing(setting)
      var existingData
      switch (setting) {
        case "locationTracking":
          viewModel.settingEditingWorkspace(viewModel.loggedInUser.locationTracking() == 1 ? 0 : 1)
          await viewModel.saveChangesToLoggedInUser()
          break
        case "password":
          existingData = ""
          break
        case "gps":
          existingData = viewModel.loggedInUser.latitude() + ", " + viewModel.loggedInUser.longitude()
          break
        default:
          existingData = viewModel.loggedInUser[setting]()
      }
      viewModel.settingEditingWorkspace(existingData)
    },

    selectView(view, data) {
      // note here that params are switched around
      // if unsure, use console.log to verify
      // console.log(data)
      // console.log(view)
      viewModel.selectedView(view)
      resetSettingEditing()
      // console.log(viewModel.selectedView())
    },

    async saveChangesToLoggedInUser() {
      var data = { id: viewModel.loggedInUser.id() }
      // add switch statement for gps handling
      if (viewModel.settingEditing() == "gps") {
        var gps = viewModel.settingEditingWorkspace().replace(" ", "").split(",")
        data["latitude"] = gps[0]
        data["longitude"] = gps[1]
      } else {
        data[viewModel.settingEditing()] = viewModel.settingEditingWorkspace()
      }
      var body = JSON.stringify(data)
      console.log(body)
      await fetch("http://localhost:3000/updateUser", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + viewModel.token(),
        },
      }).then(response =>
        response.json()
      ).then(data => {
        if (data.success) {
          if (viewModel.settingEditing() == "gps") {
            var gps = viewModel.settingEditingWorkspace().replace(" ", "").split(",")
            viewModel.loggedInUser.latitude(gps[0])
            viewModel.loggedInUser.longitude(gps[1])
          } else {
            viewModel.loggedInUser[viewModel.settingEditing()](viewModel.settingEditingWorkspace())
          }
        }
        alert(data.text)
      }).catch(er => {
        document.getElementById("errordiv").innerHTML = "Error updating own data. Reason: " + er.message + "."
      })
      resetSettingEditing()
    },

    async sendNewPassword() {
      var body = JSON.stringify({
        password: viewModel.password(),
        hash: viewModel.reset() | viewModel.settingEditingWorkspace(),
      })
      // console.log(body)
      await fetch("http://localhost:3000/resetPassword", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json'
        },
      }).then(response =>
        response.json()
      ).then(data => {
        console.log(data)
        if (data.success) {
          if (!alert(data.text)) { window.location.replace("http://localhost:3000/matcha") }
        } else {
          alert("Please request a new reset link.")
        }
      }).catch(er => {
        document.getElementById("errordiv").innerHTML = "Error sending new password. Reason: " + er.message + "."
      })
    },

    async sendNewRegistrationToDb() {
      // { "username": "qwerqwer", 
      // "password": "asdfasdf", 
      // "email": "asdf@asdf.asdf", 
      // "firstname": "asdfasdf", 
      // "lastname": "asdfasdf", 
      // "gender": "male/female/other" }
      // console.log(/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(viewModel.newRegistration.email()))
      if (viewModel.newRegistration.username().length < 4)
        alert("Username min 4 characters.")
      else if (viewModel.newRegistration.firstname().length < 4) {
        alert("Firstname min 4 characters.")
      } else if (viewModel.newRegistration.lastname().length < 4) {
        alert("Lastname min 4 characters.")
      } else if (!(/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(viewModel.newRegistration.email()))) {
        alert("Enter valid email address.")
      } else if (viewModel.newRegistration.password().length < 8) {
        alert("Password min 8 characters.")
      } else {
        var body = ko.toJSON(viewModel.newRegistration)
        // console.log(body)
        await fetch("http://localhost:3000/createUser", {
          method: "POST",
          body: body,
          headers: {
            'Content-Type': 'application/json'
          },
        }).then(response =>
          response.json()
        ).then(data => {
          // console.log(data)
          if (!data.success) {
            alert(data.text)
          } else {
            if (!alert(data.text + " . Please confirm email address.")) { window.location.replace("http://localhost:3000/matcha") }
          }
        }).catch(er => {
          // alert('Invalid credentials')
          document.getElementById("errordiv").innerHTML = "Error setting token. Reason: " + er.message + " when submitting credentials"
        })
      }
    },

    async sendResetPasswordRequest() {
      var body = JSON.stringify({
        email: viewModel.email()
      })
      // console.log(body)
      await fetch("http://localhost:3000/forgotPassword", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json'
        },
      }).then(response =>
        response.json()
      ).then(data => {
        console.log(data)
        if (data.success == true) {
          if (!alert(data.text)) { window.location.reload(); }
        }
      }).catch(er => {
        document.getElementById("errordiv").innerHTML = "Error resetting pwd. Reason: " + er.message + "."
      })
    },

    async submitCreds() {
      var body = JSON.stringify({
        username: viewModel.username(),
        password: viewModel.password(),
      })
      await fetch("http://localhost:3000/login", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json'
        },
      }).then(response =>
        response.json()
      ).then(data => {
        // console.log(data)
        if (data.token) {
          viewModel.token(data.token)
          viewModel.selectedView('notifications')
          putUserInViewModel();
        } else {
          alert(data.text)
        }
      }).catch(er => {
        // alert('Invalid credentials')
        document.getElementById("errordiv").innerHTML = "Error setting token. Reason: " + er.message + " when submitting credentials"
      })
    },

  };

  viewModel.selectedView('login')
  const params = new URLSearchParams(window.location.search)
  if (params.has("reset")) {
    viewModel.reset(params.get("reset"))
    viewModel.selectedView("reset")
  }
  if (params.has("verify")) {
    // viewModel.verify(params.get("verify"))
    // viewModel.selectedView("verify")
    // var body = ko.toJSON(viewModel.newRegistration)
    // console.log(body)
    fetch("http://localhost:3000/verify/" + params.get("verify"), {
      method: "GET",
      // body: body,
      headers: {
        'Content-Type': 'application/json'
      },
    }).then(response =>
      response.json()
    ).then(data => {
      console.log(data)
      // if (!data.success) {
      //   alert(data.text)
      // } else {
      if (!alert(data.text)) { window.location.replace("http://localhost:3000/matcha") }
      // }
    }).catch(er => {
      // alert('Invalid credentials')
      document.getElementById("errordiv").innerHTML = "Error verifying email. Reason: " + er.message + "."
    })
  }
  ko.applyBindings(viewModel);
</script>

</html>