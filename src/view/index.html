<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .navbar-item {
      margin-top: 14px;
      margin-bottom: 14px;
    }
  </style>
</head>

<body style="height:100%; margin:0; width:100%;">

  <div id="main" style="min-height:90%; margin-bottom:-50px;">
    <div style="display:inline-block;" id="logo">
      <img src="Matcha_logo.png" width="80" height="70" title="Matcha">
    </div>

    <nav data-bind="if: token()" style="padding: 10; display:inline-block;" id="navbar">
      <span class="navbar-item" data-bind="click: selectView.bind($data, 'match'), style: {padding: 14}">Match</span>
      <a class="navbar-item" href="#" style="text-decoration: none; display:inline-block; color:black;"
        data-bind="value: setInterval(countUnreadChats, 5000)">
        <span data-bind="click: selectView.bind($data, 'chat'), style: {padding: 14}">Chat</span>
        <span style="padding: 5px 10px; border-radius:50%; background-color:red; color:white;"
          data-bind="text: unreadChatsCount"></span>
      </a>
      <span class="navbar-item" data-bind="click: selectView.bind($data, 'profile'), style: {padding: 14}">Profile</span>
      <span class="navbar-item" data-bind="click: selectView.bind($data, 'settings'), style: {padding: 14}">Settings</span>
      <a class="navbar-item" href="#" style="text-decoration: none; display:inline-block; color:black;"
        data-bind="value: setInterval(countUnreadNotifications, 5000)">
        <span data-bind="click: selectView.bind($data, 'notifications'), style: {padding: 14}">Notifications</span>
        <span style="padding: 5px 10px; border-radius:50%; background-color:red; color:white;"
          data-bind="text: unreadNotificationsCount"></span>
      </a>
      <span class="navbar-item" data-bind="click: logOut, style: {padding: 14}">Log Out</span>
    </nav>
    <hr>

    <div style="width:90%;" data-bind="if: selectedView() == 'login'" id="login">
      <h3>Enter credentials to log in</h3>
      <div style="display:inline-block">
        <div>Username:</div>
        <div><input data-bind="value: username"></div>
      </div>
      <div style="display:inline-block">
        <div>Password:</div>
        <div><input type="password" data-bind="value: password"></div>
      </div>
      <div style="display:inline-block">
        <button data-bind="click: submitCreds">Log In</button>
      </div>
      <div>
        <h6>Oops, I need to <a href="" data-bind="click: selectView.bind($data, 'resetrequest')">reset my
          password</a>.</h6>
      </div>
      <div>
        <h3>New user? Click here to <a href="" data-bind="click: selectView.bind($data, 'register')">register</a>.
        </h3>
      </div>
    </div>

    <div data-bind="if: selectedView() == 'welcome'" id="welcome">
      <b>Thanks for visiting.</b>
      <div>May the matching be ever in your favour.</div>
    </div>

    <div data-bind="if: selectedView() == 'match'" id="match">

      <div data-bind="ifnot: focussedProfileIsSet" id="recommendationsView">
        <div id="sortFilterConsole">
          <table>
            <td id="sortBox">
              <b>Sorting options:</b>
              <div>
                <label for="category">Category:</label>
                <select data-bind="options: ['age', 'fame', 'distance', 'tagsInCommon'],
                                    optionsCaption: 'none',
                                    value: sortCategory,
                                    valueAllowUnset: true">
                </select>
              </div>
              <div>
                <label for="direction">Direction:</label>
                <select data-bind="options: ['ascending', 'descending'],
                                    optionsCaption: 'none',
                                    value: sortDirection,
                                    valueAllowUnset: true">
                </select>
              </div>
              <!-- <div>Tags</div> -->
            </td>
            <td id="filterBox">
              <b>Filter options:</b>
              <table>
                <tr>
                  <td>
                    <div>Age range</div>
                  </td>
                  <td>
                    <input style="width: 80;" data-bind="value: filters.ageMin">
                    <input style="width: 80;" data-bind="value: filters.ageMax">
                  </td>
                </tr>
                <tr>
                  <td>
                    <div>Fame range</div>
                  </td>
                  <td>
                    <input style="width: 80;" data-bind="value: filters.fameMin">
                    <input style="width: 80;" data-bind="value: filters.fameMax">
                  </td>
                </tr>
                <tr>
                  <td>
                    <div>Distance range</div>
                  </td>
                  <td>
                    <input style="width: 80;" data-bind="value: filters.distanceMin">
                    <input style="width: 80;" data-bind="value: filters.distanceMax">
                  </td>
                </tr>
                <tr>
                  <td>
                    <div>
                      Tags
                      <button data-bind="click: addThisTagToFilter">Add tag</button>
                      <input data-bind="value: filters.addingTag">
                    </div>
                    <div data-bind="foreach: filters.tags">
                      <button data-bind="click: $root.deleteThisTagFromFilter.bind($data)">X</button>
                      <span data-bind="text: $data"></span>
                    </div>
                  </td>
                  <td>
                  </td>
                </tr>
              </table>
            </td>
          </table>
          <button data-bind="click: putRecommendationsInViewModel">Search</button>
          <button data-bind="click: clearSearchSettings">Clear search settings</button>
        </div>

        <h3>Recommendations</h3>

        <div data-bind="ifnot: recommendations">No recommendations matching parameters found.</div>

        <div data-bind="foreach: recommendations" id="recommendationsCanvas">
          <table>
            <td id="profileImage">
              <span data-bind="foreach: images">
                <span data-bind="if: true">
                  <img width="auto" height="auto" data-bind="attr: {src: $data}" style="float: left;">
                </span>
              </span>
            </td>
            <td id="profileSummary">
              <p style="display: inline;">
                <b>Username</b>
              <div data-bind="text: username"></div>
              <b>Age</b>
              <div data-bind="text: age"></div>
              <b>Distance</b>
              <div data-bind="text: Math.ceil(distance) + ' km'"> </div>
              <b>Fame</b>
              <div data-bind="text: fame"></div>
              <b>Gender</b>
              <div data-bind="text: gender"></div>
              <b>Online</b>
              <div data-bind="text: (
                  $data.online ? 
                  'Active now' : 
                  'Last seen ' + 
                  moment(focussedProfile.lastSeen).utcOffset('+02:00').format('YYYY-MM-DD HH:mm:ss'))">
              </div>
              <b>Tags</b>
              <ul data-bind="foreach: tags">
                <li data-bind="text: $data"></li>
              </ul>
              </p>

            </td>
            <td id="buttons">
              <button style="display: block; width: 100%;"
                data-bind="click: $root.putFocusedProfileInViewModel.bind($data)">
                View Profile
              </button>
              <!-- ko if: swipeable  || createMatch -->
              <button style="display: block; width: 100%;" data-bind="click: $root.swipeRight.bind($data)">
                Swipe Right
              </button>
              <!-- /ko -->
              <!-- ko if: blockable -->
              <button style="display: block; width: 100%;" data-bind="click: $root.cancelProfile.bind($data, id)">
                Block Profile
              </button>
              <!-- /ko -->
            </td>
          </table>
          <br>
        </div>
      </div>

      <div data-bind="if: focussedProfileIsSet" id="focussedProfile">

        <div id="buttons">
          <!-- ko if: focussedProfile.swipeable || focussedProfile.createMatch -->
          <button data-bind="click: swipeRight.bind($data, ko.toJS(focussedProfile))">Swipe Right</button>
          <!-- /ko -->
          <!-- ko if: focussedProfile.blockable -->
          <button data-bind="click: cancelProfile.bind($data, focussedProfile.id())">Block Profile</button>
          <!-- /ko -->
          <button data-bind="click: reportAccount.bind($data, focussedProfile.id())">Report Fake Account</button>
        </div>

        <div data-bind="foreach: {data: focussedProfileImageSources, as: 'image'}" id="profileImage">
          <span data-bind="if: profilePicture == 1">
            <div>Profile Image:</div>
            <img width="18%" height="auto" data-bind="attr: {src: image}">
          </span>
        </div>

        <span data-bind="foreach: {data: focussedProfileImageSources, as: 'image'}" id="otherImages">
          <span data-bind="if: profilePicture == 0">
            <img width="18%" height="auto" data-bind="attr: {src: image}">
          </span>
        </span>
        <br>

        <div>
          <b>Username</b>
          <div data-bind="text: focussedProfile.username"></div>
          <br>

          <b>Online</b>
          <div data-bind="
            text: (focussedProfile.online() ? 
            'Active now' : 
            'Last seen ' + 
            moment(focussedProfile.lastSeen).utcOffset('+02:00').format('YYYY-MM-DD HH:mm:ss'))">
          </div>
          <br>
          <b>Firstname</b>
          <div data-bind="text: focussedProfile.firstname"></div>
          <br>

          <b>Lastname</b>
          <div data-bind="text: focussedProfile.lastname"></div>
          <br>

          <b>Age</b>
          <div data-bind="text: focussedProfile.age"></div>
          <br>

          <b>Gender</b>
          <div data-bind="text: focussedProfile.gender"></div>
          <br>

          <b>Interest</b>
          <div data-bind="text: focussedProfile.interest"></div>
          <br>

          <b>City</b>
          <div data-bind="text: focussedProfile.city() + ', ' + focussedProfile.countryName()"></div>
          <br>

          <b>Biography</b>
          <div data-bind="text: focussedProfile.biography() ? focussedProfile.biography : 'Not yet completed.'"></div>
          <br>

          <b>Tags</b>
          <ul data-bind="foreach: focussedProfile.tags">
            <li data-bind="text: tag"></li>
          </ul>
          <br>

          <b>Fame</b>
          <div data-bind="text: focussedProfile.fame() ? focussedProfile.fame : 'No fame rating yet.'">
          </div>
          <br>

        </div>
      </div>

    </div>

    <div data-bind="if: selectedView() == 'chat'" id="chat">
      <b>Users you can chat with:</b>
      <!-- <span data-bind="event: displayNotifications($root.loggedInUser.id)"></span> -->
      <!-- ko if: matches().length == 0 -->
      <div>You don't yet have any mutual swipes. :(</div>
      <!-- /ko -->
      <!-- ko ifnot: matches().length == 0 -->
      <div data-bind="foreach: matches">
        <div data-bind="if: accepted">
          <button style="width: auto;" data-bind="click: 
              $root.putFocusedProfileInViewModel.bind($data)">
            View Profile
          </button>
          <button data-bind="
              text: (($root.loggedInUser.username() == requester) ? accepter : requester) + (hasNewMessage() ? ' *New*' : ''), 
              click: $root.setSelectedChat.bind($data)">
          </button>
        </div>
        <br>
      </div>
      <hr>
      <!-- /ko -->
      <!-- ko if: selectedChat() > 0 -->
      <!-- <span data-bind="event: setTimeout(seenChats, 3000, selectedChat)"></span> -->
      <div data-bind="foreach: notifications">
        <!-- ko if: (sendId == $root.selectedChat() || receiveId == $root.selectedChat()) && isChat == 1 -->
        <div data-bind="text: sender + ': ' + message"></div>
        <!-- /ko -->
      </div>
      <input data-bind="value: $root.newChatMessage">
      <button data-bind="click: $root.sendNewChatMessage">Send</button>
      <!-- /ko -->
    </div>

    <div data-bind="if: selectedView() == 'profile'" id="profile">
      <!-- <button>Add new picture</button> -->
      <div data-bind="if: ownImageSources().length < 5">
        <div>Add another picture</div>
        <input type="file" id="myfile" name="myfile" accept=".png,.jpg,.jpeg"
          data-bind="event: {change: $root.fileSelect}"><br><br>
        <div data-bind="if: imageWorkspace.source()">
          <button data-bind="click: uploadNewImage">Upload New Image</button>
          <button data-bind="click: uploadProfileImage">Upload As Profile Image</button>
        </div>
      </div>

      <div style="max-width:700px" data-bind="foreach: {data: ownImageSources, as: 'image'}" id="profileImage">
        <span data-bind="if: profilePicture == 1">
          <div>Profile Image:</div>
          <img  width="40%" height="auto" data-bind="attr: {src: image}, click: $root.deleteImage.bind($data, id)">
        </span>
      </div>

      <div style="max-width:700px" data-bind="foreach: {data: ownImageSources, as: 'image'}" id="otherImages">
        <span data-bind="if: profilePicture == 0">
          <img width="40%" height="auto" data-bind="attr: {src: image}, click: $root.deleteImage.bind($data, id)">
        </span>
      </div>
      <br>

      <div>
        <b>Username</b> <!-- no edit -->
        <div data-bind="text: loggedInUser.username"></div>
        <br>

        <b>First Name</b>
        <!-- ko if: 'firstname' in loggedInUser && 
          settingEditing() != 'firstname'-->
        <button data-bind="click: selectSettingEditing.bind($data, 'firstname')">Edit</button>
        <div data-bind="text: loggedInUser.firstname"></div>
        <!-- /ko -->
        <!-- ko if: 'firstname' in loggedInUser && 
          settingEditing() == 'firstname'-->
        <button data-bind="click: saveChangesToLoggedInUser">Save</button>
        <div>
          <input data-bind="value: settingEditingWorkspace">
        </div>
        <!-- /ko -->
        <br>

        <b>Last Name</b>
        <!-- ko if: 'lastname' in loggedInUser && 
          settingEditing() != 'lastname'-->
        <button data-bind="click: selectSettingEditing.bind($data, 'lastname')">Edit</button>
        <div data-bind="text: loggedInUser.lastname"></div>
        <!-- /ko -->
        <!-- ko if: 'lastname' in loggedInUser && 
          settingEditing() == 'lastname'-->
        <button data-bind="click: saveChangesToLoggedInUser">Save</button>
        <div>
          <input data-bind="value: settingEditingWorkspace">
        </div>
        <!-- /ko -->
        <br>

        <b>Age</b>
        <!-- ko if: 'age' in loggedInUser && 
          settingEditing() != 'age'-->
        <button data-bind="click: selectSettingEditing.bind($data, 'age')">Edit</button>
        <div type="number" data-bind="text: loggedInUser.age"></div>
        <!-- /ko -->
        <!-- ko if: 'age' in loggedInUser && 
          settingEditing() == 'age'-->
        <button data-bind="click: saveChangesToLoggedInUser">Save</button>
        <div>
          <input data-bind="value: settingEditingWorkspace">
        </div>
        <!-- /ko -->
        <br>

        <b>Gender</b>
        <!-- ko if: 'gender' in loggedInUser && 
          settingEditing() != 'gender'-->
        <button data-bind="click: selectSettingEditing.bind($data, 'gender')">Edit</button>
        <div data-bind="text: loggedInUser.gender"></div>
        <!-- /ko -->
        <!-- ko if: 'gender' in loggedInUser && 
          settingEditing() == 'gender'-->
        <button data-bind="click: saveChangesToLoggedInUser">Save</button>
        <div>
          <select id="genderList" data-bind="value: settingEditingWorkspace" list="genderList">
            <option value="other">other</option>
            <option value="female">female</option>
            <option value="male">male</option>
          </select>
        </div>
        <!-- /ko -->
        <br>

        <b>Biography</b>
        <!-- ko if: 'biography' in loggedInUser && 
          settingEditing() != 'biography'-->
        <button data-bind="click: selectSettingEditing.bind($data, 'biography')">Edit</button>
        <div data-bind="text: loggedInUser.biography() ? loggedInUser.biography : 'Not yet completed.'"></div>
        <!-- /ko -->
        <!-- ko if: 'biography' in loggedInUser && 
          settingEditing() == 'biography'-->
        <button data-bind="click: saveChangesToLoggedInUser">Save</button>
        <div>
          <input data-bind="value: settingEditingWorkspace">
        </div>
        <!-- /ko -->
        <br>

        <b>Interest</b>
        <!-- ko if: 'interest' in loggedInUser && 
          settingEditing() != 'interest'-->
        <button data-bind="click: selectSettingEditing.bind($data, 'interest')">Edit</button>
        <div data-bind="text: loggedInUser.interest"></div>
        <!-- /ko -->
        <!-- ko if: 'interest' in loggedInUser && 
          settingEditing() == 'interest'-->
        <button data-bind="click: saveChangesToLoggedInUser">Save</button>
        <div>
          <select id="genderList" data-bind="value: settingEditingWorkspace" list="genderList">
            <option value="other">other</option>
            <option value="female">female</option>
            <option value="male">male</option>
          </select>
        </div>
        <!-- /ko -->
        <br>

        <!-- need to allow for multiple tags adding/deleting, not just editing a single field -->
        <b>Tags</b>
        <!-- ko if: settingEditing() != 'tag' -->
        <button data-bind="click: selectSettingEditing.bind($data, 'tag')">Add tag</button>
        <!-- /ko -->
        <!-- ko if: settingEditing() == 'tag' -->
        <button data-bind="click: saveTag">Save tag</button>
        <input data-bind="value: settingEditingWorkspace">
        <!-- /ko -->
        <div data-bind="foreach: ownTags">
          <span data-bind="text: tag"></span>
          <button data-bind="click: $root.deleteTag.bind($data)">Delete tag</button>
          <br>
        </div>
        <br>

        <b>Fame</b> <!-- no edit -->
        <div
          data-bind="text: loggedInUser.fame() ? loggedInUser.fame : 'No fame rating yet. Interact with other users to increase.'">
        </div>
        <br>

        <!-- ko if: loggedInUser.locationTracking -->
        <b>GPS</b>
        <!-- ko if: settingEditing() != 'gps'-->
        <button data-bind="click: selectSettingEditing.bind($data, 'gps')">Edit</button>
        <table>
          <tr>
            <td>
              <div data-bind="text: 'Latitude:'"></div>
            </td>
            <td>
              <div data-bind="text: loggedInUser.latitude"></div>
            </td>
          </tr>
          <tr>
            <td>
              <div data-bind="text: 'Longitude:'"></div>
            </td>
            <td>
              <div data-bind="text: loggedInUser.longitude"></div>
            </td>
          </tr>
        </table>
        <!-- /ko -->
        <!-- ko if: settingEditing() == 'gps'-->
        <button data-bind="click: saveChangesToLoggedInUser">Save</button>
        <div>
          <input data-bind="value: settingEditingWorkspace">
        </div>
        <!-- /ko -->
        <br>
        <!-- /ko -->

      </div>

    </div>

    <div data-bind="if: selectedView() == 'settings'" id="settings">
      <!-- username -->
      <!-- password -->
      <!-- email -->
      <!-- dis/enable gps-->
      <h3>Pick a setting to change.</h3>




      <b>Username</b>
      <!-- ko if: settingEditing() != 'username'-->
      <button data-bind="click: selectSettingEditing.bind($data, 'username')">Edit</button>
      <div data-bind="text: loggedInUser.username"></div>
      <!-- /ko -->
      <!-- ko if: settingEditing() == 'username'-->
      <button data-bind="click: saveChangesToLoggedInUser">Save</button>
      <div>
        <input data-bind="value: settingEditingWorkspace">
      </div>
      <!-- /ko -->
      <br>

      <b>Password</b>
      <!-- ko if: settingEditing() != 'password' -->
      <button data-bind="click: selectSettingEditing.bind($data, 'password')">Edit</button>
      <!-- /ko -->
      <!-- ko if: settingEditing() == 'password' -->
      <button data-bind="click: saveChangesToLoggedInUser">Save</button>
      <div>
        <input type="password" data-bind="value: settingEditingWorkspace">
      </div>
      <!-- /ko -->
      <br>

      <b>Email</b>
      <!-- ko if: settingEditing() != 'email' -->
      <button data-bind="click: selectSettingEditing.bind($data, 'email')">Edit</button>
      <div data-bind="text: loggedInUser.email"></div>
      <!-- /ko -->
      <!-- ko if: settingEditing() == 'email' -->
      <button data-bind="click: saveChangesToLoggedInUser">Save</button>
      <div>
        <input type="email" data-bind="value: settingEditingWorkspace">
      </div>
      <!-- /ko -->
      <br>

      <b>Location Tracking</b>
      <button data-bind="click: selectSettingEditing.bind($data, 'locationTracking')">Toggle</button>
      <div data-bind="text: loggedInUser.locationTracking() == 1 ? 'Enabled' : 'Disabled'"></div>
      <br>

    </div>

    <div data-bind="if: selectedView() == 'notifications'" id="notifications">
      <!-- need to fix time display -->
      <span data-bind="event: displayNotifications()"></span>
      <span data-bind="event: setTimeout(seenNotifications, 5000, notifications)"></span>
      <table style="width:100%" data-bind="value: setTimeout(displayNotifications, 5500)">
        <tbody data-bind="foreach: {data:notifications, as: 'notif'}">
          <tr
            data-bind="if: 'username' in $root.loggedInUser && receiver == $root.loggedInUser.username() && isChat == 0 && message != 'also liked'">
            <td style="padding:20px; border-bottom:1px solid black;"
              data-bind="style: { color: seenReceiver == 0 ? 'red' : 'black' }">
              <button style="width: auto;" data-bind="click: $root.putFocusedProfileInViewModel.bind($data)">
                View Profile
              </button>
              <span data-bind="text: sender"></span>
              <span data-bind="text: message"></span>
              <span>your profile</span>
              <span
                data-bind="text: moment(createdAt).utcOffset('+02:00').format('YYYY-MM-DD HH:mm:ss')"></span>
            </td>
          </tr>
          <tr
            data-bind="if: 'username' in $root.loggedInUser && sender == $root.loggedInUser.username() && isChat == 0 && message != 'also liked'">
            <td style="padding:20px; border-bottom:1px solid black;"
              data-bind="style: { color: seenSender == 0 ? 'red' : 'black' }">
              <button style="width: auto;" data-bind="click: $root.putFocusedProfileInViewModel.bind($data)">
                View Profile
              </button>
              <span>You</span>
              <span data-bind="text: message"></span>
              <span data-bind="text: receiver"></span>
              <span
                data-bind="text: moment(createdAt).utcOffset('+02:00').format('YYYY-MM-DD HH:mm:ss')"></span>
            </td>
          </tr>
          <tr
            data-bind="if: 'username' in $root.loggedInUser && sender == $root.loggedInUser.username() && isChat == 0 && message == 'also liked'">
            <td style="padding:20px; border-bottom:1px solid black;"
              data-bind="style: { color: seenReceiver == 0 ? 'red' : 'black' }">
              <button style="width: auto;" data-bind="click: $root.putFocusedProfileInViewModel.bind($data)">
                View Profile
              </button>
              <span data-bind="text: receiver"></span>
              <span data-bind="text: message"></span>
              <span>You</span>
              <span
                data-bind="text: moment(createdAt).utcOffset('+02:00').format('YYYY-MM-DD HH:mm:ss')"></span>
            </td>
          </tr>
          <tr
            data-bind="if: 'username' in $root.loggedInUser && receiver == $root.loggedInUser.username() && isChat == 0 && message == 'also liked'">
            <td style="padding:20px; border-bottom:1px solid black;"
              data-bind="style: { color: seenReceiver == 0 ? 'red' : 'black' }">
              <button style="width: auto;" data-bind="click: $root.putFocusedProfileInViewModel.bind($data)">
                View Profile
              </button>
              <span>You</span>
              <span data-bind="text: message"></span>
              <span data-bind="text: sender"></span>
              <span
                data-bind="text: moment(createdAt).utcOffset('+02:00').format('YYYY-MM-DD HH:mm:ss')"></span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div data-bind="if: selectedView() == 'reset'" id="reset">
      <h3>Please enter your new password:</h3>
      <input type="password" data-bind="value: password">
      <button data-bind="click: sendNewPassword">Reset Password</button>
      <div><button data-bind="click: logOut">Return to Log In</button></div>
    </div>

    <div data-bind="if: selectedView() == 'resetrequest'" id="resetrequest">
      <h3>Please provide your email address:</h3>
      <input data-bind="value: email">
      <button data-bind="click: sendResetPasswordRequest">Send Request</button>
      <div><button data-bind="click: viewModel.selectView.bind($data, 'login')">Return to Log In</button></div>
    </div>

    <div data-bind="if: selectedView() == 'register'" id="register">
      <h3>Please provide the following information to register:</h3>
      <div>Username:</div>
      <input data-bind="value: newRegistration.username">
      <div>Firstname:</div>
      <input data-bind="value: newRegistration.firstname">
      <div>Lastname:</div>
      <input data-bind="value: newRegistration.lastname">
      <div>Age:</div>
      <input
        onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
        data-bind="value: newRegistration.age">
      <div>Gender:</div>
      <select id="genderList" data-bind="value: newRegistration.gender" list="genderList">
        <option value="other">other</option>
        <option value="female">female</option>
        <option value="male">male</option>
      </select>
      <div>Email:</div>
      <input type="email" data-bind="value: newRegistration.email">
      <div>Password:</div>
      <input type="password" data-bind="value: newRegistration.password">
      <p> </p>
      <div>
        <button data-bind="click: sendNewRegistrationToDb">Register</button>
        <button data-bind="click: viewModel.selectView.bind($data, 'login')">Return to Log In</button>
      </div>
    </div>
  </div>
  <footer style="text-align:center; padding:30px; height:50px; margin-top:10px;">
    <p>Authors: hde-vos jrheeder clongmor revan-wy</p>
  </footer>
</body>

<script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js'></script>
<script type='text/javascript' src='knockout.mapping.js'></script>
<script type='text/javascript' src='moment.min.js'></script>
<script>

  async function putMatchesInViewModel() {
    // { "id": 1 }
    var body = JSON.stringify({
      id: viewModel.loggedInUser.id(),
    })
    // console.log(body)
    await fetch("http://localhost:3000/getMatches", {
      method: "POST",
      body: body,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + viewModel.token(),
      },
    }).then(response =>
      response.json()
    ).then(data => {
      // console.log(data)
      if (data.success) {
        data.matches.forEach(match => {
          match.hasNewMessage = ko.observable(false)
        });
        viewModel.matches(data.matches)
        // console.log(ko.toJS(viewModel.matches))
      } else {
        if (!alert("Couldn't grab matches. Please try again.")) { viewModel.selectView("welcome", null) }
      }
    }).catch(er => {
      console.log("Error setting matches for chat. Reason: " + er.message + ".")
    })
  }

  async function putRecommendationsInViewModel() {
    // { "id": 1 }
    var body = JSON.stringify({
      id: viewModel.loggedInUser.id(),
      filters: {
        ageMax: viewModel.filters.ageMax(),
        ageMin: viewModel.filters.ageMin(),
        fameMin: viewModel.filters.fameMin(),
        fameMax: viewModel.filters.fameMax(),
        distanceMin: viewModel.filters.distanceMin(),
        distanceMax: viewModel.filters.distanceMax(),
        tags: ko.toJS(viewModel.filters.tags),
      },
      sorting: {
        category: viewModel.sortCategory(),
        direction: viewModel.sortDirection(),
        tagsInCommon: viewModel.sortTags(),
      },
    })
    await fetch("http://localhost:3000/getMatchRecommendations", {
      method: "POST",
      body: body,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + viewModel.token(),
      },
    }).then(response =>
      response.json()
    ).then(data => {
      // console.log(data)
      if (data.success) {
        viewModel.recommendations(data.matches)
        // viewModel.recommendations().forEach(recommendation => {
        //   recommendation.distance = ceil
        // });
        // console.log(viewModel.recommendations())
      } else {
        if (!alert(data.text)) {
          viewModel.clearSearchSettings()
          // viewModel.selectView("match", null) 
        }
      }
    }).catch(er => {
      console.log("Error setting recommendations. Reason: " + er.message + ".")
    })
    // console.log(ko.toJS(viewModel.recommendations))
    // console.log(viewModel.ownImageSources())
  }

  async function putUserInViewModel(id) {
    // console.log("starting putuserinviewmodel")
    var body = JSON.stringify({
      profileId: id,
    })
    await fetch("http://localhost:3000/profile", {
      method: "POST",
      body: body,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + viewModel.token(),
      },
    }).then(response =>
      response.json()
    ).then(data => {
      // console.log(data)
      if (data.user && data.images) {
        viewModel.loggedInUser = ko.mapping.fromJS(data.user)
        viewModel.ownImageSources(data.images)
        viewModel.ownTags(data.tags)
        // data.images.forEach(image => {
        //   viewModel.ownImageSources().push(image.image)
        // });
      } else {
        if (!alert('Unable to complete login. Please try again.')) { window.location.replace("http://localhost:3000/matcha") }
      }
    }).catch(er => {
      console.log("Error setting logged in user data. Reason: " + er.message + ".")
    })
    // console.log(ko.toJS(viewModel.loggedInUser))
    // console.log(viewModel.ownImageSources())
  }

  function resetSettingEditing() {
    // console.log("reset setting editing called")
    viewModel.settingEditing('')
    viewModel.settingEditingWorkspace('')
  }

  async function sendNewNotification(data) {
    var body = JSON.stringify(data)
    // console.log(data)
    await fetch("http://localhost:3000/createNotifications", {
      method: "POST",
      body: body,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + viewModel.token(),
      },
    }).then(response =>
      response.json()
    ).then(data => {
      // console.log(data)
      if (data.success) {
        viewModel.displayNotifications(viewModel.loggedInUser.id())
      } else {
        if (!alert('Unable to send notification. Please try again.')) { }
      }
    }).catch(er => {
      console.log("Error sending new notification. Reason: " + er.message + ".")
    })
  }

  var viewModel = {
    email: ko.observable(""),
    filters: {
      ageMax: ko.observable(),
      ageMin: ko.observable(),
      fameMin: ko.observable(),
      fameMax: ko.observable(),
      distanceMin: ko.observable(),
      distanceMax: ko.observable(),
      tags: ko.observableArray([]),
      addingTag: ko.observable(""),
    },
    focussedProfile: ko.observable(null),
    focussedProfileImageSources: ko.observable(null),
    focussedProfileIsSet: ko.observable(false),
    imageWorkspace: {
      source: ko.observable(""),
      profilePicture: ko.observable(0),
    },
    loggedInUser: {},
    matches: ko.observable([]),
    newChatMessage: ko.observable(""),
    newRegistration: {
      age: ko.observable(""),
      email: ko.observable(""),
      firstname: ko.observable(""),
      gender: ko.observable(""),
      lastname: ko.observable(""),
      password: ko.observable(""),
      username: ko.observable(""),
    },
    ownImageSources: ko.observable([]),
    ownTags: ko.observable([]),
    password: ko.observable(""),
    recommendations: ko.observable([]),
    reset: ko.observable(),
    selectedChat: ko.observable(""),
    selectedView: ko.observable(""),
    settingEditing: ko.observable(""),
    settingEditingWorkspace: ko.observable(""),
    sortCategory: ko.observable(),
    sortDirection: ko.observable(),
    sortTags: ko.observable(),
    token: ko.observable(),
    unreadChatsCount: ko.observable(0),
    unreadNotificationsCount: ko.observable(0),
    username: ko.observable(""),
    notifications: ko.observable([]),

    addThisTagToFilter() {
      console.log(ko.toJS(viewModel.filters.addingTag))
      viewModel.filters.tags.push(viewModel.filters.addingTag())
      viewModel.filters.addingTag("")
      console.log(ko.toJS(viewModel.filters.tags))
    },

    async cancelProfile(targetProfileId, data) {
      // { "acceptId": 5, "requestId": 3 }
      var body = JSON.stringify({
        acceptId: targetProfileId,
        requestId: viewModel.loggedInUser.id(),
      })
      // console.log(body)
      await fetch("http://localhost:3000/blockMatch", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + viewModel.token(),
        },
      }).then(response =>
        response.json()
      ).then(data => {
        console.log(data)
        alert(data.text)
      }).catch(er => {
        console.log("Error blocking match. Reason: " + er.message + ".")
      })
      viewModel.focussedProfileIsSet(false)
      viewModel.focussedProfile = null
      putRecommendationsInViewModel()
    },

    async reportAccount(targetProfileId, data) {
      var body = JSON.stringify({
        id: targetProfileId,
      })
      // console.log(body)
      await fetch("http://localhost:3000/reportFalseAccount", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + viewModel.token(),
        },
      }).then(response =>
        response.json()
      ).then(data => {
        alert(data.text)
      }).catch(er => {
        console.log("Error reporting user. Reason: " + er.message + ".")
      })
      viewModel.focussedProfileIsSet(false)
      viewModel.focussedProfile = null
      putRecommendationsInViewModel()
    },

    clearSearchSettings() {
      viewModel.sortCategory(null)
      viewModel.sortDirection(null)
      viewModel.sortTags(null)
      viewModel.filters.ageMin(null)
      viewModel.filters.ageMax(null)
      viewModel.filters.distanceMin(null)
      viewModel.filters.distanceMax(null)
      viewModel.filters.fameMin(null)
      viewModel.filters.fameMax(null)
      viewModel.filters.tags.removeAll()
    },

    async deleteImage(id, data) {
      if (!confirm("Delete image?")) return
      var body = JSON.stringify({ id: String(id) })
      // console.log(body)
      await fetch("http://localhost:3000/deletePicture", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + viewModel.token(),
        },
      }).then(response =>
        response.json()
      ).then(data => {
        if (data.success) {
          putUserInViewModel(viewModel.loggedInUser.id())
        }
        alert(data.text)
      }).catch(er => {
        console.log("Error updating own data. Reason: " + er.message + ".")
      })
    },

    async deleteTag(data) {
      // console.log(data)
      var body = JSON.stringify(data)
      await fetch("http://localhost:3000/deleteTag", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + viewModel.token(),
        },
      }).then(response =>
        response.json()
      ).then(data => {
        alert(data.text)
        // console.log("end of then")
      }).catch(er => {
        console.log("Error updating own data. Reason: " + er.message + ".")
      })
      putUserInViewModel(viewModel.loggedInUser.id())
      // console.log("end of save tag reached")
    },

    deleteThisTagFromFilter(data) {
      viewModel.filters.tags.remove(data)
    },

    fileSelect(element, event) { // limit size 1000000
      // console.log(event.target.files)
      var file = event.target.files[0]
      if (file.size > 1000000) {
        alert("Must be smaller than 1MB.")
        return
      }
      var reader = new FileReader();
      reader.onload = (function (theFile) {
        return function (e) {
          viewModel.imageWorkspace.source(e.target.result)
          // console.log(viewModel.loggedInUser)
        };
      })(file);
      reader.readAsDataURL(file);
    },

    async logOut() {
      var data = {}
      if ("id" in viewModel.loggedInUser)
        data = { id: viewModel.loggedInUser.id() }
      var body = JSON.stringify(data)
      // console.log(body)
      await fetch("http://localhost:3000/logout", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(response =>
        // console.log(response)
        response.json()
      ).then(data => {
        // console.log(data)
        if (data.success) {
          alert(data.text)
          window.location.replace("http://localhost:3000/matcha")
        } else {
          return
        }
      }).catch(er => {
        console.log("Error logging out. Reason: " + er.message + ".")
      })
    },

    async putFocusedProfileInViewModel(data) {
      // console.log(data)
      if ("sendId" in data) {
        var body = JSON.stringify({
          profileId: viewModel.loggedInUser.username() == data.sender ? data.receiveId : data.sendId,
          viewerId: viewModel.loggedInUser.id(),
        })
      } else if ("acceptId" in data) {
        var body = JSON.stringify({
          profileId: viewModel.loggedInUser.username() == data.requester ? data.acceptId : data.requestId,
          viewerId: viewModel.loggedInUser.id(),
        })
      } else {
        var body = JSON.stringify({
          profileId: data.userId || data.id,
          viewerId: viewModel.loggedInUser.id(),
        })
      }
      // console.log(body)
      await fetch("http://localhost:3000/profile", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + viewModel.token(),
        },
      }).then(response =>
        response.json()
      ).then(data => {
        console.log(data)
        if (data.user && data.images) {
          viewModel.selectView('match')
          viewModel.focussedProfile = ko.mapping.fromJS(data.user)
          viewModel.focussedProfileImageSources = data.images
          viewModel.focussedProfile.tags(data.tags)
          viewModel.focussedProfileIsSet(true)
        } else {
          if (!alert('Unable to load target profile. Please try again.')) { viewModel.selectView("welcome", null) }
        }
      }).catch(er => {
        console.log("Error loading target profile. Reason: " + er.message + ".")
      })
      // console.log(ko.toJS(viewModel.focussedProfile))
    },

    async selectSettingEditing(setting, data) {
      viewModel.settingEditing(setting)
      var existingData
      switch (setting) {
        case "locationTracking":
          viewModel.settingEditingWorkspace(viewModel.loggedInUser.locationTracking() == 1 ? 0 : 1)
          await viewModel.saveChangesToLoggedInUser()
          break
        case "password":
          existingData = ""
          break
        case "gps":
          existingData = viewModel.loggedInUser.latitude() + ", " + viewModel.loggedInUser.longitude()
          break
        case "tag":
          existingData = ""
          break
        default:
          existingData = viewModel.loggedInUser[setting]()
      }
      viewModel.settingEditingWorkspace(existingData)
    },

    selectView(view, data) {
      // note here that params are switched around
      // if unsure, use console.log to verify
      // console.log(data)
      // console.log(view)
      scroll(0, 0)
      viewModel.selectedView(view)
      resetSettingEditing()
      // console.log(viewModel.selectedView())
      switch (view) {
        case "match":
          putRecommendationsInViewModel()
          viewModel.focussedProfileIsSet(false)
          break
        case "chat":
          putMatchesInViewModel()
          // viewModel.selectedChat(null)
          break
      }
      // console.log(viewModel.selectedView())
    },

    async saveTag() {
      // body = { userId: 1, tag: "lovePies"}
      var data = {
        userId: viewModel.loggedInUser.id(),
        tag: viewModel.settingEditingWorkspace()
      }
      var body = JSON.stringify(data)
      // console.log(body)
      await fetch("http://localhost:3000/createTag", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + viewModel.token(),
        },
      }).then(response =>
        response.json()
      ).then(data => {
        alert(data.text)
        // console.log("end of then")
      }).catch(er => {
        console.log("Error updating own data. Reason: " + er.message + ".")
      })
      resetSettingEditing()
      putUserInViewModel(viewModel.loggedInUser.id())
      // console.log("end of save tag reached")
    },

    async saveChangesToLoggedInUser() {
      var data = { id: viewModel.loggedInUser.id() }
      // add switch statement for gps handling
      if (viewModel.settingEditing() == "gps") {
        var gps = viewModel.settingEditingWorkspace().replace(" ", "").split(",")
        data["latitude"] = gps[0]
        data["longitude"] = gps[1]
      } else if (viewModel.settingEditing() == "password" && !(viewModel.settingEditingWorkspace().length > 7)) {
        alert("Password should have at least 8 characters.")
        resetSettingEditing()
        return
      } else {
        data[viewModel.settingEditing()] = viewModel.settingEditingWorkspace()
      }
      var body = JSON.stringify(data)
      // console.log(body)
      await fetch("http://localhost:3000/updateUser", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + viewModel.token(),
        },
      }).then(response =>
        response.json()
      ).then(data => {
        if (data.success) {
          if (viewModel.settingEditing() == "gps") {
            var gps = viewModel.settingEditingWorkspace().replace(" ", "").split(",")
            viewModel.loggedInUser.latitude(gps[0])
            viewModel.loggedInUser.longitude(gps[1])
          } else {
            viewModel.loggedInUser[viewModel.settingEditing()](viewModel.settingEditingWorkspace())
          }
        }
        alert(data.text)
      }).catch(er => {
        console.log("Error updating own data. Reason: " + er.message + ".")
      })
      resetSettingEditing()
    },

    sendNewChatMessage(data) {
      // { "sendId": 1, "receiveId": 2, "message": "New Message!" }
      data = {
        receiveId: viewModel.selectedChat(),
        sendId: viewModel.loggedInUser.id(),
        message: viewModel.newChatMessage(),
        isChat: 1,
        seenSender: 1,
      }
      viewModel.newChatMessage("")
      sendNewNotification(data)
      // console.log(ko.toJS(viewModel.notifications))
    },

    async sendNewPassword() {
      var body = JSON.stringify({
        password: viewModel.password(),
        hash: viewModel.settingEditingWorkspace().length ? viewModel.settingEditingWorkspace() : viewModel.reset(),
      })
      // console.log(body)
      await fetch("http://localhost:3000/resetPassword", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json'
        },
      }).then(response =>
        response.json()
      ).then(data => {
        console.log(data)
        if (data.success) {
          if (!alert(data.text)) { window.location.replace("http://localhost:3000/matcha") }
        } else {
          alert("Please request a new reset link.")
        }
      }).catch(er => {
        console.log("Error sending new password. Reason: " + er.message + ".")
      })
    },

    async sendNewRegistrationToDb() {
      // { "username": "qwerqwer", 
      // "password": "asdfasdf", 
      // "email": "asdf@asdf.asdf", 
      // "firstname": "asdfasdf", 
      // "lastname": "asdfasdf", 
      // "gender": "male/female/other" }
      // console.log(/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(viewModel.newRegistration.email()))
      if (viewModel.newRegistration.username().length < 4)
        alert("Username min 4 characters.")
      else if (viewModel.newRegistration.firstname().length < 4) {
        alert("Firstname min 4 characters.")
      } else if (viewModel.newRegistration.lastname().length < 4) {
        alert("Lastname min 4 characters.")
      } else if (!(/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(viewModel.newRegistration.email()))) {
        alert("Enter valid email address.")
      } else if (viewModel.newRegistration.password().length < 8) {
        alert("Password min 8 characters.")
      } else {
        var body = ko.toJSON(viewModel.newRegistration)
        // console.log(body)
        await fetch("http://localhost:3000/createUser", {
          method: "POST",
          body: body,
          headers: {
            'Content-Type': 'application/json'
          },
        }).then(response =>
          response.json()
        ).then(data => {
          // console.log(data)
          if (!data.success) {
            alert(data.text)
          } else {
            if (!alert(data.text + " . Please confirm email address.")) { window.location.replace("http://localhost:3000/matcha") }
          }
        }).catch(er => {
          // alert('Invalid credentials')
          console.log("Error setting token. Reason: " + er.message + " when submitting credentials")
        })
      }
    },

    async sendResetPasswordRequest() {
      var body = JSON.stringify({
        email: viewModel.email()
      })
      // console.log(body)
      await fetch("http://localhost:3000/forgotPassword", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json'
        },
      }).then(response =>
        response.json()
      ).then(data => {
        console.log(data)
        if (data.success == true) {
          if (!alert(data.text)) { window.location.reload(); }
        }
      }).catch(er => {
        console.log("Error resetting pwd. Reason: " + er.message + ".")
      })
    },

    setSelectedChat(data) {
      match = ko.toJS(data)
      // console.log(notification)
      chatPartnerId = viewModel.loggedInUser.id() == match.requestId ? match.acceptId : match.requestId
      // console.log(chatPartnerId) // goal here is 8
      viewModel.selectedChat(chatPartnerId)
      viewModel.newChatMessage("")
      viewModel.seenChats(chatPartnerId)
      // console.log(ko.toJS(viewModel.notifications))
    },

    async submitCreds() {
      var body = JSON.stringify({
        username: viewModel.username(),
        password: viewModel.password(),
      })
      await fetch("http://localhost:3000/login", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json'
        },
      }).then(response =>
        response.json()
      ).then(data => {
        // console.log(data)
        if (data.token) {
          viewModel.token(data.token)
          viewModel.selectedView("welcome")
          putUserInViewModel(data.id)
          viewModel.displayNotifications(data.id)
        } else {
          alert(data.text)
        }
      }).catch(er => {
        // alert('Invalid credentials')
        console.log("Error setting token. Reason: " + er.message + " when submitting credentials")
      })
    },

    async swipeRight(targetProfile, data) {
      // console.log(data.id || targetProfile.id)
      if (!viewModel.ownImageSources().length) {
        alert("You need at least one image in your own profile to complete this action.")
        return
      }
      // { "acceptId": 5, "requestId": 3 }
      var body = JSON.stringify({
        acceptId: data.id || targetProfile.id,
        requestId: viewModel.loggedInUser.id(),
      })
      await fetch("http://localhost:3000/createMatch", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + viewModel.token(),
        },
      }).then(response =>
        response.json()
      ).then(data => {
        // console.log(data)
        alert(data.text)
        // console.log(viewModel.focussedProfileIsSet())
        if (viewModel.focussedProfileIsSet() == true) {
          if (viewModel.focussedProfile.swipeable)
            viewModel.focussedProfile.swipeable(0)
          else
            viewModel.focussedProfile.createMatch(0)
        } else {
          putRecommendationsInViewModel()
        }
      }).catch(er => {
        console.log("Error creating match. Reason: " + er.message + ".")
      })
    },

    async uploadNewImage() {
      var body = JSON.stringify({
        userId: viewModel.loggedInUser.id(),
        image: viewModel.imageWorkspace.source(),
        profilePicture: viewModel.imageWorkspace.profilePicture(),
      })
      await fetch("http://localhost:3000/uploadPicture", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + viewModel.token(),
        },
      }).then(response =>
        response.json()
      ).then(data => {
        if (data.success) {
          putUserInViewModel(viewModel.loggedInUser.id())
        }
        alert(data.text)
      }).catch(er => {
        console.log("Error updating own data. Reason: " + er.message + ".")
      })
      viewModel.imageWorkspace.source("")
      viewModel.imageWorkspace.profilePicture(0)
    },

    uploadProfileImage() {
      viewModel.imageWorkspace.profilePicture(1)
      viewModel.uploadNewImage()
    },

    async displayNotifications(id) {
      if ("id" in viewModel.loggedInUser)
        targetId = viewModel.loggedInUser.id()
      else targetId = id
      var body = JSON.stringify({
        id: targetId,
      })
      await fetch("http://localhost:3000/getNotifications", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + viewModel.token(),
        },
      }).then(response =>
        response.json()
      ).then(data => {
        if (data.success && data.notifications) {
          viewModel.notifications(data.notifications)
          // console.log(viewModel.notifications())
          // putUserInViewModel(viewModel.loggedInUser.id())
        }
      }).then(() => {
        if ("id" in viewModel.loggedInUser) {
          myId = viewModel.loggedInUser.id()
          jsMatches = viewModel.matches()
          jsMatches.forEach(element => {
            element.hasNewMessage(false)
          });
          viewModel.notifications().forEach(notification => {
            // console.log(notification)
            if (notification.isChat && notification.receiveId == myId && !notification.seenReceiver) {
              sendId = notification.sendId
              jsMatches.forEach(element => {
                if (element.requestId == sendId || element.acceptId == sendId) {
                  element.hasNewMessage(true)
                  // console.log(hasNewMessage)
                }
              });
            }
          });
          viewModel.matches(jsMatches)
        }
      }).catch(er => {
        console.log("Error getting notifications. Reason: " + er.message + ".")
      })
    },

    async seenChats(sendId) {
      var body = JSON.stringify({
        id: ko.toJS(viewModel.loggedInUser.id),
        isChat: 1,
        sendId: ko.toJS(sendId),
      })
      await fetch("http://localhost:3000/setNotificationsAsSeen", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + viewModel.token(),
        },
      }).then(response =>
        response.json()
      ).then(data => {
        // if (data.success) {
        //   viewModel.notifications(notifs)
        //   // putUserInViewModel(viewModel.loggedInUser.id())
        // }
      }).catch(er => {
        console.log("Error setting chats as seen. Reason: " + er.message + ".")
      })
    },

    async seenNotifications(notifs) {
      var body = JSON.stringify({
        id: viewModel.loggedInUser.id(),
        isChat: 0,
      })
      await fetch("http://localhost:3000/setNotificationsAsSeen", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + viewModel.token(),
        },
      }).then(response =>
        response.json()
      ).then(data => {
        if (data.success) {
          viewModel.notifications(notifs)
          // putUserInViewModel(viewModel.loggedInUser.id())
        }
      }).catch(er => {
        console.log("Error setting notifications as seen. Reason: " + er.message + ".")
      })
    },

    async countUnreadChats() {
      var body = JSON.stringify({
        id: viewModel.loggedInUser.id(),
        isChat: 1,
      })
      await fetch("http://localhost:3000/getNumberOfUnreadNotifications", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + viewModel.token(),
        },
      }).then(response =>
        response.json()
      ).then(data => {
        if (data.success) {
          viewModel.unreadChatsCount(data.number)
          // putUserInViewModel(viewModel.loggedInUser.id())
        }
      }).catch(er => {
        console.log("Error counting unread notifications. Reason: " + er.message + ".")
      })
    },

    async countUnreadNotifications() {
      var body = JSON.stringify({
        id: viewModel.loggedInUser.id(),
        isChat: 0,
      })
      await fetch("http://localhost:3000/getNumberOfUnreadNotifications", {
        method: "POST",
        body: body,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + viewModel.token(),
        },
      }).then(response =>
        response.json()
      ).then(data => {
        if (data.success) {
          viewModel.unreadNotificationsCount(data.number)
          // putUserInViewModel(viewModel.loggedInUser.id())
        }
      }).catch(er => {
        console.log("Error counting unread notifications. Reason: " + er.message + ".")
      })
    },

  };

  viewModel.selectedView('login')
  const params = new URLSearchParams(window.location.search)
  if (params.has("reset")) {
    viewModel.reset(params.get("reset"))
    viewModel.selectedView("reset")
  }
  if (params.has("verify")) {
    // viewModel.verify(params.get("verify"))
    // viewModel.selectedView("verify")
    // var body = ko.toJSON(viewModel.newRegistration)
    // console.log(body)
    fetch("http://localhost:3000/verify/" + params.get("verify"), {
      method: "GET",
      // body: body,
      headers: {
        'Content-Type': 'application/json'
      },
    }).then(response =>
      response.json()
    ).then(data => {
      console.log(data)
      // if (!data.success) {
      //   alert(data.text)
      // } else {
      if (!alert(data.text)) { window.location.replace("http://localhost:3000/matcha") }
      // }
    }).catch(er => {
      // alert('Invalid credentials')
      console.log("Error verifying email. Reason: " + er.message + ".")
    })
  }
  ko.applyBindings(viewModel);
</script>

</html>